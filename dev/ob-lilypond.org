* ob-lilypond
** Stages
*** DONE Get something working ish! 
*** DONE Decide directory Structure
*** DONE Decide LilyPond-mode and lilypond-hook integration wrt ob-lilypond
Use seperate hook in ob-lilypond to auto draw / play under preferences
*** DONE Get correct basename on build files
*** DONE Add ob-ly-compile-post-tangle user variable (default t)
If ob-ly-compile-post-tangle flag set compile tangled file
Use defvar rather than defcustom for now

*** DONE Add ob-ly-draw-pdf-post-tangle  user variable (default t)
If ob-ly-draw-pdf-post-tangle is true draw pdf of tangled ly file given the
compilation didn't fail.
Use defvar rather than defcustom for now

*** DONE Add ob-ly-play-midi-post-tangle user variable (default t)
If ob-ly-play-midi-post-tangle is true play generated midi file of tangled ly file given the
compilation didn't fail.
Use defvar rather than defcustom for now
*** DONE Test whether we need to explicitly check for 
    existance of pdf and MIDI files before auto display or play
Done with warnings if lilypond doesn't generate
*** DONE Refactor org-babel-execute-tangled-ly to smaller chunks
*** DONE ly-determine-app-path refactoring
*** DONE Modify org-babel-execute:lilypond to actually perform tangle
Since ob-lilypond is currently all about tangling, modify C-c C-c
action to perform tangling and subsequent processing. This way we
no longer need to use post-tangle-hook and differentiates between
simple tangling, and tangle + processing.
*** DONE Add command to toggle playing of midi file
*** DONE Add command to toggle displaying pdf file
*** DONE Modify so that given a syntax error ob-lilypond will attempt 
    to highlight the line containing the error in the original
    pre-tangled org file (rather than the generated ly file)
*** DONE Remove the need to explicitly indicate tangled lilypond blocks
This will mean that all lilypond blocks are :tangle: yes by default,
which currently makes sense - enabled by passing in "yes" as tangle
file to org-babel-tangle

*** DONE Further Refactor example.org
*** DONE Export html version of example.org and add to repo
*** DONE Add exported link to readme
*** DONE Add ly-toggle-png-generation command
*** DONE Port to Ubuntu
*** TODO Finish tests [34/40]
 1. [X] (defalias 'lilypond-mode 'LilyPond-mode)
 2. [ ] list 'org-babel-tangle-lang-exts '("LilyPond" . "ly"))
 3. [X] ly-compile-post-tangle t
 4. [X] ly-display-pdf-post-tangle t
 5. [X] ly-play-midi-post-tangle t
 6. [X] ly-OSX-ly-path
 7. [X] ly-OSX-pdf-path "open")
 8. [X] ly-OSX-midi-path "open")
 9. [X] ly-nix-ly-path "/usr/bin/lilypond")
 10. [X] ly-nix-pdf-path "evince")
 11. [X] ly-nix-midi-path "timidity")
 12. [X] ly-win32-ly-path "lilypond")
 13. [X] ly-win32-pdf-path "")
 14. [X] ly-win32-midi-path "")
 15. [X] ly-gen-png nil)
 16. [X] ly-gen-svg nil)
 17. [X] ly-gen-html nil)
 18. [X] ly-use-eps nil)
 19. [X] org-babel-default-header-args:lilypond
 20. [-] org-babel-expand-body:lilypond (body params)
 21. [-] org-babel-execute:lilypond (body params)
 22. [ ] org-babel-prep-session:lilypond (session params)
 23. [ ] ly-execute-tangled-ly ()
 24. [ ] ly-compile-lilyfile (file-name)
 25. [X] ly-check-for-compile-error (file-name)
 26. [X] ly-process-compile-error (file-name)
 27. [X] ly-mark-error-line (file-name line)
 28. [X] ly-parse-line-num ()
 29. [X] ly-parse-error-line (file-name lineNo)
 30. [X] ly-attempt-to-open-pdf (file-name)
 31. [X] ly-attempt-to-play-midi (file-name)
 32. [X] ly-determine-ly-path ()
 33. [X] ly-determine-pdf-path ()
 34. [X] ly-determine-midi-path ()
 35. [X] ly-toggle-midi-play ()
 36. [X] ly-toggle-pdf-display ()
 37. [X] ly-toggle-png-generation ()
 38. [X] ly-toggle-html-generation ()
 39. [X] ly-switch-extension (file-name ext)
 40. [X] (provide 'ob-lilypond)

*** TODO Figure out export with lower case lilypond restriction
*** DONE Decide How to handle OS dependencies
 - midi player
 - pdf viewer
 - LilyPond location (Set up seperate binary paths relative to OS)
 - LilyPond API (OSX needs special treatment at the very least
*** DONE Figure out why Emacs occasionally auto-loads filename.lilypond!
**** DONE Reduced scope of (save-excursion) to avoid this - doesn't help
**** DONE Perhaps need unwind-protection - causes issues
**** TODO Modify error marking to use absolute block size counting for location
*** WAITING Get feedback from Shelagh regarding direction and current 
*** SOMEDAY Consider drawing vector graphic output as opposed to pdf for viewing?
*** SOMEDAY Consider the option to embed resultant partial musical output into org file 

** Setup
*** Add dev switch hook

#+BEGIN_SRC emacs-lisp
  
  (defun ob-lilypond-switch-src-control-file()
    "Fast route to ob-lilypond.org and back"
    (interactive)
    (let ((project-file 
           (concat dotfiles-dir
                   "martyn/martyn/ob-lilypond/dev/ob-lilypond.org"))
          (buffer))
      (unless (boundp 'ly-last-buffer)
              (setq ly-last-buffer
                    (concat dotfiles-dir
                            "martyn/martyn/ob-lilypond/lib/ob-lilypond.el")))
      (if (equal (buffer-file-name) project-file)
          (setq buffer ly-last-buffer)
        (setq ly-last-buffer (buffer-file-name))
        (setq buffer project-file))
      (message (concat "Switching to " buffer))
      (switch-to-buffer  (file-name-nondirectory buffer))))
  (global-set-key [f4] 'ob-lilypond-switch-src-control-file)
    
#+END_SRC
#+results:
: ob-lilypond-switch-src-control-file

*** Add Continuous Testing hook

#+BEGIN_SRC emacs-lisp
  
  (defun ob-lilypond-eval-src-and-tests ()
    (interactive)
    (let ((original-buffer buffer-file-name)
          (original-window (selected-window)))
      (if(string-match "^ob-lilypond" (file-name-nondirectory original-buffer)) 
          (progn
            (eval-buffer "ob-lilypond-tests.el")
            (eval-buffer "ob-lilypond.el")
            (ert t)))
      (select-window original-window)))
   
(save-buffer "ob-lilypond.el")
(save-buffer "ob-lilypond-tests.el")
(add-hook 'after-save-hook 'ob-lilypond-eval-src-and-tests nil nil)
(save-excursion
  (set-buffer "ob-lilypond.el")
  (revert-buffer nil t) 
  (set-buffer "ob-lilypond-tests.el")
  (revert-buffer nil t))
 
#+END_SRC

#+results:
: t

*** Remove Continuous Testing Hook

#+BEGIN_SRC emacs-lisp :results silent

;;(set-buffer "ob-lilypond.el")  

(save-buffer "ob-lilypond.el")
(save-buffer "ob-lilypond-tests.el")
(remove-hook 'after-save-hook 'ob-lilypond-eval-src-and-tests nil)
(save-excursion
  (set-buffer "ob-lilypond.el")
  (revert-buffer nil t) 
  (set-buffer "ob-lilypond-tests.el")
  (revert-buffer nil t))

#+END_SRC

*** Remove ALL After Save Hooks 

#+BEGIN_SRC emacs-lisp :results silent
  
(setq after-save-hook nil)  

#+END_SRC

*** Display all after save hooks 

#+BEGIN_SRC emacs-lisp

(message "%S" after-save-hook)
 
#+END_SRC

#+results:
: (ob-lilypond-eval-src-and-tests)

*** Setup Dev Project

#+BEGIN_SRC emacs-lisp 

  (defun lilypond-project ()
    (interactive)
    (when (fboundp 'unity-mode)
      (unload-feature 'unity-mode t))
    (when (fboundp 'unity-mode-tests)
      (unload-feature 'unity-mode-tests t))
    (add-to-list 'load-path
                 (concat dotfiles-dir  "martyn/martyn/ob-lilypond"))
    (delete-other-windows)
    (split-window-horizontally)
    (windmove-right)
    (find-file "~/.emacs.d/martyn/martyn/ob-lilypond/dev/ob-lilypond.org")
    (find-file "~/.emacs.d/martyn/martyn/ob-lilypond/lib/ob-lilypond.el")
    (windmove-left)
    (find-file "~/.emacs.d/martyn/martyn/ob-lilypond/test/ob-lilypond-tests.el")
    (switch-to-buffer "ob-lilypond-tests.el")
    (split-window-vertically)
    (switch-to-buffer "*ert*")
    (windmove-down)
    (switch-to-buffer "ob-lilypond-tests.el"))
  (lilypond-project)
#+END_SRC
#+results:
: #<buffer ob-lilypond-tests.el>

*** Dev Tangle Command

#+BEGIN_SRC emacs-lisp
 
(defun ly-dev-tangle ()
  (interactive)
  (set-buffer "misty.org")
  (let ((current (point)))
    (goto-char (point-min))
    (org-babel-next-src-block)
    (org-babel-execute-src-block)))
(global-set-key [f8] 'ly-dev-tangle)

#+END_SRC

